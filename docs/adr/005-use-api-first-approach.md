# ADR 004: Использование подхода API-First (OpenAPI Generation)

**Статус:** Принято
**Дата:** 24 февраля 2026 г.

## 1. Контекст и проблема
Для взаимодействия с фронтендом, внешними системами и между модулями (в случае синхронных HTTP-вызовов) требуется четко определенный REST API контракт.
Использование подхода Code-First (генерация документации из аннотаций в коде контроллеров) приводит к ряду проблем:
* Контроллеры перегружаются инфраструктурными аннотациями Swagger/OpenAPI, скрывая саму маршрутизацию.
* Изменения в контракте сложно отслеживать на этапе Code Review, так как они размазаны по коду.
* Параллельная разработка усложняется: потребители API (фронтенд или другие команды) не могут начать интеграцию, пока не написан и не запущен код бэкенда.

## 2. Решение
Мы принимаем подход **API-First (Design-First)** в качестве стандарта для всех REST API интерфейсов приложения.

* **Единый источник истины:** Контракт API пишется вручную в формате `openapi.yaml` (OpenAPI v3) до начала написания бизнес-логики.
* **Автогенерация кода:** На этапе сборки проекта (с помощью `openapi-generator-gradle-plugin`) из YAML-файла автоматически генерируются интерфейсы контроллеров и data-классы (DTO).
* **Стек генерации:** Используется генератор `kotlin-spring` с включенной поддержкой WebFlux и корутин (`suspend` функций).
* **Чистые контроллеры:** Разработчик создает класс контроллера, который имплементирует сгенерированный интерфейс, и реализует только вызов слоя Application, без единой аннотации Swagger.

## 3. Последствия

### Положительные:
* **Четкий контракт:** Изменения API (особенно ломающие) видны в PR сразу на уровне YAML-файла.
* **Чистый код:** В коде отсутствуют аннотации `@Operation`, `@Schema` и `@ApiResponse`.
* **Упрощение тестирования:** Наличие YAML-файла позволяет сразу генерировать WireMock-стабы для контрактного и интеграционного тестирования, не дожидаясь реализации контроллеров.

### Риски и компромиссы:
* **Кривая обучения:** Разработчикам необходимо уметь писать валидные OpenAPI спецификации вручную.
* **Настройка сборки:** Требуется поддержка и обновление конфигурации плагина `openapi-generator` в `build.gradle.kts`.
* **Ограничения генератора:** В редких случаях генератор может создавать неоптимальные названия классов, что требует дополнительной настройки маппинга (`typeMappings` / `importMappings`).
