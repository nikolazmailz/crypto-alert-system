# ADR 002: Использование архитектуры Modulith (Модульный монолит)

**Статус:** Accepted
**Дата:** YYYY-MM-DD.

## 1. Контекст и проблема
Для старта нового проекта и выстраивания эталонных инженерных практик необходимо выбрать базовую архитектуру. Проект будет постепенно наполняться новым функционалом, поэтому архитектура должна способствовать легкости разработки и тестирования, предотвращая при этом деградацию кодовой базы (превращение в "Big Ball of Mud").

Рассматривались следующие варианты:
* **Традиционный монолит (Слоистая архитектура):** Легко развертывать, но по мере роста проекта границы между предметными областями стираются, что приводит к сильной связности (coupling) и усложняет поддержку.
* **Микросервисы:** Обеспечивают строгую изоляцию, но требуют значительных накладных расходов на инфраструктуру, усложняют сквозное тестирование и транзакционность. На текущем этапе развития проекта это неоправданный оверхед.

Необходим подход, который обеспечит простоту развертывания монолита, но заставит соблюдать строгие границы между логическими модулями на уровне кода.

## 2. Решение
Мы принимаем архитектурный стиль **Модульный монолит (Modulith)** в качестве основы для проекта.

* Приложение будет развертываться и запускаться как единый процесс (одно Spring Boot приложение).
* Внутренняя структура кодовой базы будет разделена на независимые бизнес-модули (по предметным областям).
* Межмодульное взаимодействие будет осуществляться исключительно двумя способами:
  1. Синхронно — через строго определенные публичные API (интерфейсы) модулей.
  2. Асинхронно — через событийно-ориентированную модель (Application Events).
* Прямые вызовы внутренних (internal/private) компонентов других модулей строго запрещены.
* Нарушение архитектурных границ модулей должно отслеживаться и пресекаться автоматически на этапе прогона тестов (например, через интеграцию с тестами архитектуры).

## 3. Последствия

### Положительные:
* **Высокая скорость разработки:** Отсутствие сетевых задержек, сериализации и сложного девопса. Легкий запуск приложения и инфраструктуры локально.
* **Строгая изоляция:** Модули остаются независимыми. Снижается когнитивная нагрузка на разработчика при работе над конкретной фичей.
* **Готовность к масштабированию:** Слабая связность модулей позволит в будущем легко вынести любой из них в полноценный отдельный сервис при возникновении такой необходимости.

### Риски и компромиссы:
* **Единая точка отказа:** Так как это физически один процесс, критическая ошибка (например, OOM) в одном модуле приведет к падению всего приложения.
* **Разделение данных:** Требуется строгая дисциплина в работе с базой данных (PostgreSQL), чтобы модули не обращались к чужим таблицам напрямую, в обход API модуля-владельца.
* **Конфликты зависимостей:** Все модули делят один classpath и версии транзитивных зависимостей.


[//]: # (# [ADR-002] Microservices Architecture)

[//]: # ()
[//]: # (**Status:** Accepted)

[//]: # (**Date:** 2024-02-18)

[//]: # ()
[//]: # (## Context)

[//]: # (Мы создаем High-Load систему мониторинга криптовалют.)

[//]: # (Требования:)

[//]: # (* Независимое масштабирование &#40;агрегатор котировок требует много CPU/Network, рассыльщик уведомлений — I/O&#41;.)

[//]: # (* Отказоустойчивость &#40;падение одного модуля не должно валить всю систему&#41;.)

[//]: # (* Возможность использования разных технологий.)

[//]: # ()
[//]: # (## Decision)

[//]: # (Мы выбираем **Microservices Architecture**.)

[//]: # (Система разбивается на автономные сервисы:)

[//]: # (1.  `market-data-service` &#40;Ingestion&#41;.)

[//]: # (2.  `portfolio-manager-service` &#40;Core Domain&#41;.)

[//]: # (3.  `notification-dispatcher` &#40;Egress&#41;.)

[//]: # (4.  `shared-kernel` Общий код &#40;DTO, Exceptions, Utils&#41;.)

[//]: # ()
[//]: # (Коммуникация:)

[//]: # (* Синхронная: REST &#40;WebFlux&#41; для запросов "здесь и сейчас".)

[//]: # (* Асинхронная: Message Broker &#40;Kafka/RabbitMQ&#41; для событий &#40;Event-Driven&#41;.)

[//]: # ()
[//]: # (## Consequences)

[//]: # (**Плюсы:**)

[//]: # (* Изоляция сбоев.)

[//]: # (* Независимый деплой.)

[//]: # (* Четкие границы контекстов &#40;Bounded Contexts&#41;.)

[//]: # ()
[//]: # (**Минусы:**)

[//]: # (* Сложность инфраструктуры &#40;Docker, K8s, Service Discovery&#41;.)

[//]: # (* Распределенные транзакции &#40;Saga pattern&#41;.)

[//]: # (* Сложность отладки &#40;Distributed Tracing&#41;.)
