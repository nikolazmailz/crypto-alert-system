# [ADR-007] Использование Liquibase (Formatted SQL) для миграций базы данных

**Status:** Proposed
**Date:** 2026-02-25

## Context
Нашему модульному монолиту требуется надежный инструмент для управления схемой базы данных PostgreSQL. Схема БД должна версионироваться вместе с кодом.
Так как мы используем R2DBC для реактивной работы с БД, инструмент миграций будет запускаться на этапе инициализации Spring Context через отдельное JDBC-соединение.
Нам необходим баланс: мы хотим использовать мощные функции управления миграциями, но при этом писать скрипты на нативном SQL PostgreSQL, избегая перегруженного синтаксиса XML или YAML.

## Decision
Мы выбираем **Liquibase** в качестве системы управления миграциями, но с жестким ограничением: **использовать исключительно формат Formatted SQL**.
Все миграции будут представлять собой `.sql` файлы, размеченные специальными комментариями Liquibase (например, `-- liquibase formatted sql` и `-- changeset author:id`). Использование XML, YAML или JSON форматов для написания миграций запрещено.

## Consequences

**Положительные:**
* **Нативный SQL:** Разработчики пишут привычный и максимально оптимизированный код для PostgreSQL (с использованием специфичных фич типа JSONB, партицирования и т.д.).
* **Мощный движок Liquibase:** В отличие от простого прогона скриптов, мы сохраняем доступ к продвинутым функциям Liquibase через SQL-комментарии: `preconditions` (проверки перед запуском), `contexts` и `labels` (запуск разных скриптов для test/prod сред).
* **Прозрачность ревью:** На Code Review изменения в `.sql` файлах читаются легко и однозначно.
* **Поддержка откатов:** Откаты (`-- rollback`) поддерживаются, но пишутся разработчиком явно в том же SQL-файле.

**Отрицательные:**
* **Отсутствие авто-откатов:** В отличие от XML/YAML, где Liquibase сам знает, как отменить `createTable`, в Formatted SQL разработчик обязан писать скрипт отката (`-- rollback drop table my_table;`) вручную.
* **Привязка к вендору БД:** Скрипты жестко завязаны на синтаксис PostgreSQL, что исключает легкий переезд на другую СУБД (однако в рамках нашего проекта такая миграция не планируется).
* **Бойлерплейт в комментариях:** В каждом файле необходимо поддерживать правильную структуру мета-комментариев Liquibase, ошибка в которых может сломать парсинг скрипта.
